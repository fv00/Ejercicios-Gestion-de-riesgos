---
title: "Ejercicios basicos de modelamiento"
author: "Santiago Franco"
date: "12/5/2022"
output:
  html_document: default
  pdf_document: default
---


```{r}
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(magrittr)
library(ROCit)
library(randomForest)
library(stringr)
library(stats)
library(glmtoolbox)
```

```{r}
mapa_de_calor <- function(categoria1, categoria2, relleno){
  p <- ggplot(aes(x=categoria1, y=categoria2, fill= relleno)) + geom_tile()
  return(p)
}
```



```{r}
datos <- read.table("base6.dat", header = TRUE)
tabla_mostrar <- head(datos) %>%
  mutate_if(is.numeric, round, digits=2)
names(tabla_mostrar) <- str_replace_all(names(tabla_mostrar), "\\.", ' ')
(names(tabla_mostrar))
grid.table(tabla_mostrar, theme=ttheme_default(base_size = 4))
```

## Preparación datos para el modelo:

```{r}
## Variables categóricas:
datos$tamaño <- as.factor(datos$tamaño)
datos$sector <- as.factor(datos$sector)
datos$Default <- as.factor(datos$Default)


## Datos para el modelo
datos_modelo <- datos[-c(3)]
```

## Análisis descriptivo de los datos

### Variable respuesta

```{r}
ggplot(data=datos, aes(x=Default)) + 
  geom_bar() + 
  geom_text(stat='count', aes(label=round(..count../sum(..count..),2)), vjust=-1) + 
  ylim(0,770) + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank()) + ggtitle('Cantidad de carteras en default')
```
A simple vista se observa que se tienen dos categorías desbalanceadas en la base de datos para establecer el modelo.


### Tamaño de la empresa
```{r}
### Heatmap
p <- ggplot(data=datos, aes(x=tamaño, fill=Default)) +
  geom_bar(position = 'dodge') +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank()) 
p
```

### Sector

```{r}
### Heatmap
p <- ggplot(data=datos, aes(x=sector, fill=Default)) +
  geom_bar(position = 'dodge') +
  theme_bw() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank()) 
p
```


### Margen Operativo
```{r}
### Grafica violín
ggplot(data=datos, aes(y=Default,
                       x=UtilNeta.Patrimonio,
                       fill=Default)) +
  geom_boxplot(trim = F)
```


### Margen Ebitda
```{r}
### Grafica violín
ggplot(data=datos, aes(y=Default,
                       x=Ebitda.ActivoTotal,
                       fill=Default)) +
  geom_boxplot()
```


### Ebitda/ Gasto Financiero

```{r}
### Grafica violín
ggplot(data=datos, aes(x=Ebitda.ActivoTotal,
                       fill=Default)) +
  geom_boxplot(position = 'dodge')
```


### Pasivo Fcro. Total / (Ebitda - Gasto Fcro)

```{r}
### Grafica violín
ggplot(data=datos, aes(x=Ebitda.ActivoTotal,
                       fill=Default)) +
  geom_boxplot(position = 'dodge')
```


### Margen Neto

```{r}
### Grafica violín
ggplot(data=datos, aes(x=Ebitda.ActivoTotal,
                       fill=Default)) +
  geom_boxplot(position = 'dodge')
```

### Ebitda / Activo Total
```{r}
### Grafica violín
ggplot(data=datos, aes(x=Ebitda.ActivoTotal,
                       fill=Default)) +
  geom_boxplot(position = 'dodge')
```

### SALDO DEUDA
```{r}
### Grafica violín
ggplot(data=datos, aes(x=Ebitda.ActivoTotal,
                       fill=Default)) +
  geom_boxplot(position = 'dodge')
```


##Implementacion modelo logit

```{r}
datos_modelo <- datos[4:11]
modelo_logit <- glm(Default ~ ., family = binomial, data=datos_modelo)
summary(modelo_logit)
```
### Depuración del modelo:

A simple vista se observa que las variables categóricas pertenecientes a la base de datos no tienen aparentemente diferencias signficativas respecto a la cantidad de default que hay asociado a una categoría, es decir, aparentemente la probabilidad de default es homogenea entre carteras. Por lo que se realiza un modelo sin incluir las variables categóricas:

```{r}
datos_modelo_1 <- datos[5:11]
modelo_depuracion1 <-  glm(Default ~ ., family = binomial, data=datos_modelo_1)
summary(modelo_depuracion1)
```
```{r}
data.frame(cor(datos_modelo_1[1:6]))
```
```{r}
datos_modelo_final <- datos[c('UtilNeta.Patrimonio', 'Ciclo.Efectivo', 'Pasivo.Activos', 'Default')]
modelo_final <- glm(Default ~ ., family = binomial, data=datos_modelo_final)
summary(modelo_final)
```

###Tabla de coeficientes

```{r}
summary(modelo_final)
```
###Valores P

###Pruebas de ajuste

```{r}
hltest(modelo_final)
```

### Validacion cruzada

```{r}
predicciones_originales <- predict(modelo_final, type = 'response')
predicciones <- ifelse(predicciones_originales >0.2, 1, 0)
table(predicciones, datos$Default)
```
###Curva ROC

```{r}
roc <- rocit(score = predicciones_originales, class=datos$Default)
plot(roc)
```

## Gráfica de las densidades de las probabilidades de default estimadas por modelo logit
```{r}
d.hat = modelo_final$fitted.values
plot(density(d.hat))
```
* escribir al final las 4 gráficas con un marplot

##Implementacion de random forest

```{r}
rf <- randomForest(Default ~ ., data = datos_modelo_final)
```

```{r}
library(rpart)
library(party)
```

```{r}
x <- ctree(Default ~ ., data = datos_modelo_final)
plot(x, type='simple')
```

## Gráfica de las densidades de las probabilidades de default estimadas por bosques aleatorios

```{r}
pesos_rf <- rf$votes[,2]
plot(density(pesos_rf))
```


###Curva ROC arboles aleatorios
```{r}
roc_rf <- rocit(pesos_rf, class = datos$Default)
plot(roc_rf)
```


##Implementacion de Knn

```{r}
library(kernlab)
library(caret)
library(randomForest)
```

```{r}
modelos_knn <- list()
for (i in 1:10) {
  modelo_knn <- knn3(Default ~ ., data=datos_modelo_final, k=i)
  modelos_knn[[i]] <- sum(predict(modelo_knn, newdata=datos_modelo_final)[,2] == datos$Default)/length(datos$Default)
}
#K=2
modelo_knn <- knn3(Default ~ ., data=datos_modelo_final, k=2)
pesos <- predict(modelo_knn, newdata=datos_modelo_final, type ="prob")[,2]
```

###Curva ROC

```{r}
roc_knn <- rocit(score=pesos, class=datos$Default)
plot(roc_knn)
##Depurar !!
```


##Implementacion de SVM
```{r}

```

###Curva ROC

## Curva ROC para todos los modelos
## AUC de todos los modelos

##Simulacion con la peor estimacion

##Simulacion con la mejor estimacion

### Comparacion de resultados